<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title></title>
</head>
<body>

<h1>Web MIDI API - MIDI IN & OUT</h1>
<div>
  <h2>select MIDI</h2>
  <div id="messageArea" class="ui-state-highlight ui-corner-all" style="border: 1px solid #ccc; margin:5px; padding: 5px;"></div>

  <p>
  <p>IN - Count : <span id="inCount"></span></p>
  <p><select name="inputPort" id="inputPort" size="1"  onChange="changeInput()">
  </select></p>
  </p>

  <p>
  <p>OUT - Count : <span id="outCount"></span></p>
  <p><select name="outputPort" id="outputPort" size="1" onChange="changeOutput()">
  </select></p>
  </p>
</div>


<p>
<p>キーボード</p>
<div id="keyboard"></div>
</p>

<script src="http://cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js"></script>
<script src="midi.js"></script>
<script>
var N_OCTAVE = 7;
var OCT_W = 210;
function makeDataset() {
  var dataset = [];
  var idx = 0;
  for (var i = 0; i < N_OCTAVE; i++) {
    var oct = i * 12;
    var xOffset = OCT_W * i;
    // C D E F G A B
    dataset[oct + idx    ]  = {'noteNr': 24 + oct, 'x':  20 + xOffset, 'y': 10, 'height': 100, 'width': 30, 'fill': 'white'};
    dataset[oct + idx + 1]  = {'noteNr': 26 + oct, 'x':  50 + xOffset, 'y': 10, 'height': 100, 'width': 30, 'fill': 'white'};
    dataset[oct + idx + 2]  = {'noteNr': 28 + oct, 'x':  80 + xOffset, 'y': 10, 'height': 100, 'width': 30, 'fill': 'white'};
    dataset[oct + idx + 3]  = {'noteNr': 29 + oct, 'x': 110 + xOffset, 'y': 10, 'height': 100, 'width': 30, 'fill': 'white'};
    dataset[oct + idx + 4]  = {'noteNr': 31 + oct, 'x': 140 + xOffset, 'y': 10, 'height': 100, 'width': 30, 'fill': 'white'};
    dataset[oct + idx + 5]  = {'noteNr': 33 + oct, 'x': 170 + xOffset, 'y': 10, 'height': 100, 'width': 30, 'fill': 'white'};
    dataset[oct + idx + 6]  = {'noteNr': 35 + oct, 'x': 200 + xOffset, 'y': 10, 'height': 100, 'width': 30, 'fill': 'white'};
    // C# D#
    dataset[oct + idx + 7]  = {'noteNr': 25 + oct, 'x':  38 + xOffset, 'y': 10, 'height':  70, 'width': 18, 'fill': 'black'};
    dataset[oct + idx + 8]  = {'noteNr': 27 + oct, 'x':  72 + xOffset, 'y': 10, 'height':  70, 'width': 18, 'fill': 'black'};
    // F# G# A#
    dataset[oct + idx + 9]  = {'noteNr': 30 + oct, 'x': 128 + xOffset, 'y': 10, 'height':  70, 'width': 18, 'fill': 'black'};
    dataset[oct + idx + 10] = {'noteNr': 32 + oct, 'x': 160 + xOffset, 'y': 10, 'height':  70, 'width': 18, 'fill': 'black'};
    dataset[oct + idx + 11] = {'noteNr': 34 + oct, 'x': 192 + xOffset, 'y': 10, 'height':  70, 'width': 18, 'fill': 'black'};
  }
  return dataset;
}

dataset = makeDataset();

var svg = d3.select('#keyboard')
  .append('svg').attr({'height': 120, 'width': (OCT_W) * 8 + 10});

function circle(x, y) {
  svg.append('circle')
    .attr({'cx': x, 'cy': y, 'r': 0})
    .attr({'fill': 'none', 'stroke': 'orange'})
    .transition().delay(100).duration(2000)
    .attr('stroke-width', 2).attr('r', 500)
    .remove();
}

svg.selectAll('rect')
  .data(dataset)
  .enter()
  .append('rect')
  .attr('x', function(d){ return d.x; })
  .attr('y', function(d){ return d.y; })
  .attr('height', function(d){ return d.height; })
  .attr('width', function(d){ return d.width; })
  .attr('fill', function(d){ return d.fill; })
  .attr('stroke','black')
  .on('click', function(d) {
    circle(d3.mouse(this)[0], d3.mouse(this)[1]);
    // sound(d.noteNr);
    echoMIDIMessage2(0x90, d.noteNr)
  });
</script>
</body>
</html>
